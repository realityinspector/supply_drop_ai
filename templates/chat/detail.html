{% extends "base.html" %}

{% block title %}Chat - {{ chat.title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header with analyzed files and new chat button -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-semibold text-gray-900">{{ chat.title }}</h1>
                {% if documents %}
                <div class="mt-2 text-sm text-gray-600">
                    Analyzed files:
                    {% for doc in documents %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">
                        {{ doc.filename }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="flex space-x-4">
                {% if 'Insurance Analysis' in chat.title and documents|length >= 2 %}
                <a href="{{ url_for('chat.insurance_wizard', step=3, reuse_docs=True, claim_doc_id=documents[0].id, requirements_doc_id=documents[1].id) }}" 
                   class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Run Another Analysis
                </a>
                {% endif %}
                <form action="{{ url_for('chat.new_chat') }}" method="POST">
                    <input type="hidden" name="current_chat_id" value="{{ chat.id }}">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        New Chat
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Warning Banner -->
    <div id="warning-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4" role="alert">
        <p class="font-bold">Warning</p>
        <p id="warning-message"></p>
    </div>

    <!-- Messages Area -->
    <div id="messages-container" class="flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
        {% for message in messages %}
            {% if message.role == 'system' %}
                <div class="bg-yellow-50 rounded-lg p-6 shadow-sm">
                    <div class="flex items-start space-x-4">
                        <div class="h-10 w-10 rounded-full bg-yellow-500 flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-medium">SYS</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ message.content }}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') if message.created_at else '' }}
                            </div>
                        </div>
                    </div>
                </div>
            {% elif message.role == 'assistant' %}
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex items-start space-x-4">
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-medium">AI</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            {% set content = message.content|from_json %}
                            {% if content is mapping %}
                                <div class="prose max-w-none space-y-6">
                                    {% if content.analysis %}
                                        {% if content.analysis.summary %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Summary</h3>
                                                <p class="text-sm text-gray-700">{{ content.analysis.summary }}</p>
                                            </div>
                                        {% endif %}

                                        {% if content.analysis.score is defined %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Score</h3>
                                                <div class="flex items-center">
                                                    <div class="w-16 h-16 rounded-full bg-{{ 'green' if content.analysis.score >= 70 else 'yellow' if content.analysis.score >= 50 else 'red' }}-100 flex items-center justify-center">
                                                        <span class="text-xl font-bold text-{{ 'green' if content.analysis.score >= 70 else 'yellow' if content.analysis.score >= 50 else 'red' }}-700">{{ content.analysis.score }}</span>
                                                    </div>
                                                    <span class="ml-3 text-sm text-gray-500">/100</span>
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if content.analysis.recommendations %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Recommendations</h3>
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for rec in content.analysis.recommendations %}
                                                        <li class="text-sm text-gray-700">{{ rec }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}

                                        {% if content.analysis.issues %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Issues</h3>
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for issue in content.analysis.issues %}
                                                        <li class="text-sm text-gray-700">{{ issue }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}

                                        {% if content.analysis.improvements %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Improvements</h3>
                                                {% for priority, items in content.analysis.improvements.items() %}
                                                    <div class="mb-4">
                                                        <h4 class="text-md font-medium text-gray-700 mb-2 capitalize">{{ priority|replace('_', ' ') }}</h4>
                                                        <ul class="list-disc pl-5 space-y-1">
                                                            {% for item in items %}
                                                                <li class="text-sm text-gray-700">{{ item }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}

                                        {% if content.analysis.details %}
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 mb-2">Details</h3>
                                                {% if content.analysis.details.matching_requirements %}
                                                    <div class="mb-4">
                                                        <h4 class="text-md font-medium text-gray-700 mb-2">Matching Requirements</h4>
                                                        <ul class="list-disc pl-5 space-y-1">
                                                            {% for req in content.analysis.details.matching_requirements %}
                                                                <li class="text-sm text-gray-700">{{ req }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {# For any other structured JSON that's not an analysis #}
                                        {% for key, value in content.items() %}
                                            <div class="mb-4">
                                                <h3 class="text-lg font-medium text-gray-900 mb-2 capitalize">{{ key|replace('_', ' ') }}</h3>
                                                {% if value is mapping %}
                                                    {% for subkey, subvalue in value.items() %}
                                                        <div class="mb-2">
                                                            <h4 class="text-md font-medium text-gray-700 mb-1 capitalize">{{ subkey|replace('_', ' ') }}</h4>
                                                            {% if subvalue is sequence and subvalue is not string %}
                                                                <ul class="list-disc pl-5 space-y-1">
                                                                    {% for item in subvalue %}
                                                                        <li class="text-sm text-gray-700">{{ item }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            {% else %}
                                                                <p class="text-sm text-gray-700">{{ subvalue }}</p>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                {% elif value is sequence and value is not string %}
                                                    <ul class="list-disc pl-5 space-y-1">
                                                        {% for item in value %}
                                                            <li class="text-sm text-gray-700">{{ item }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <p class="text-sm text-gray-700">{{ value }}</p>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ message.content }}</p>
                            {% endif %}
                            <div class="mt-2 text-xs text-gray-500">
                                {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') if message.created_at else '' }}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex items-start space-x-4">
                        <div class="h-10 w-10 rounded-full bg-gray-500 flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-medium">{{ current_user.username[0]|upper }}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ message.content }}</p>
                            <div class="mt-2 text-xs text-gray-500">
                                {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') if message.created_at else '' }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Message Input -->
    <div class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <form id="message-form" class="flex space-x-4">
                <div class="flex-1">
                    <label for="message" class="sr-only">Message</label>
                    <textarea
                        id="message"
                        name="message"
                        rows="3"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-lg resize-none"
                        placeholder="Type your message..."
                    ></textarea>
                </div>
                <div class="flex-shrink-0">
                    <button
                        type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('message-form');
    const textarea = document.getElementById('message');
    const submitButton = form.querySelector('button[type="submit"]');
    const messagesContainer = document.getElementById('messages-container');
    const warningBanner = document.getElementById('warning-banner');
    const warningMessage = document.getElementById('warning-message');
    
    // Auto-focus the textarea
    textarea.focus();
    
    function showLoadingIndicator() {
        submitButton.disabled = true;
        submitButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending...
        `;
    }
    
    function hideLoadingIndicator() {
        submitButton.disabled = false;
        submitButton.textContent = 'Send';
    }

    function showWarning(message) {
        warningMessage.innerHTML = message;
        warningBanner.classList.remove('hidden');
    }

    function hideWarning() {
        warningBanner.classList.add('hidden');
    }

    function addMessage(role, content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'bg-white rounded-lg p-6 shadow-sm';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="h-10 w-10 rounded-full bg-${role === 'user' ? 'gray' : 'blue'}-500 flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-medium">${role === 'user' ? '{{ current_user.username[0]|upper }}' : 'AI'}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-900 whitespace-pre-wrap">${content}</p>
                    <div class="mt-2 text-xs text-gray-500">${timestamp}</div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function sendMessage(content) {
        if (!content.trim()) return;
        
        showLoadingIndicator();
        hideWarning();

        try {
            const response = await fetch('{{ url_for("chat.send_message", chat_id=chat.id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            const data = await response.json();

            if (response.ok) {
                addMessage('user', data.user_message.content, data.user_message.timestamp);
                addMessage('assistant', data.assistant_message.content, data.assistant_message.timestamp);
                textarea.value = '';
                textarea.style.height = 'auto';
            } else if (response.status === 413 && data.warning) {
                showWarning(data.error);
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send message. Please try again.');
        } finally {
            hideLoadingIndicator();
        }
    }
    
    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await sendMessage(textarea.value);
    });

    // Handle textarea auto-resize
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Handle Enter key (without shift) to submit
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(this.value);
        }
    });
});
</script>
{% endblock %} 