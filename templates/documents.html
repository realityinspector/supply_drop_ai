{% extends "base.html" %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
        <div class="loading-spinner"></div>
        <p id="loadingText" class="loading-text">Processing...</p>
    </div>
</div>

<div class="max-w-6xl mx-auto">
    <!-- Insurance Document Processing Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Insurance Document Processing</h2>
        <div class="space-y-6">
            <!-- Step 1: Insurance Requirements Upload -->
            <div class="border-b pb-6">
                <h3 class="text-lg font-semibold mb-3">Step 1: Upload Insurance Requirements and Policy</h3>
                <form id="requirementsForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Select Requirements Document</label>
                        <input type="file" 
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" 
                               id="requirementsDoc" 
                               accept=".pdf,.docx,.txt,.md,.json">
                        <div id="requirementsProgress" class="progress-bar mt-2 hidden">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <p id="requirementsStatus" class="status-message"></p>
                    </div>
                    <button type="submit" 
                            class="btn btn-primary w-full sm:w-auto transform hover:scale-105 active:scale-95 transition-all duration-200">
                        <span class="relative inline-flex items-center">
                            Upload Requirements
                            <span class="absolute right-0 -mr-1 h-4 w-4 animate-ping rounded-full bg-white opacity-75 hidden"></span>
                        </span>
                    </button>
                </form>
            </div>

            <!-- Step 2: Insurance Claim Upload -->
            <div class="border-b pb-6">
                <h3 class="text-lg font-semibold mb-3">Step 2: Upload Insurance Claim/Application</h3>
                <form id="claimForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Select Claim Document</label>
                        <input type="file" 
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" 
                               id="claimDoc" 
                               accept=".pdf,.docx,.txt,.md,.json">
                        <div id="claimProgress" class="progress-bar mt-2 hidden">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <p id="claimStatus" class="status-message"></p>
                    </div>
                    <button type="submit" 
                            class="btn btn-primary w-full sm:w-auto transform hover:scale-105 active:scale-95 transition-all duration-200">
                        <span class="relative inline-flex items-center">
                            Upload Claim
                            <span class="absolute right-0 -mr-1 h-4 w-4 animate-ping rounded-full bg-white opacity-75 hidden"></span>
                        </span>
                    </button>
                </form>
            </div>

            <!-- Step 3: Analysis Options -->
            <div>
                <h3 class="text-lg font-semibold mb-4">Step 3: Analysis Options</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="analyzeDocuments('critique')" 
                            class="analysis-btn btn btn-primary group relative overflow-hidden transform hover:scale-105 active:scale-95 transition-all duration-200 disabled:transform-none disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Critique/Reject Analysis
                        </span>
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                    </button>
                    <button onclick="analyzeDocuments('enhance')" 
                            class="analysis-btn btn btn-primary group relative overflow-hidden transform hover:scale-105 active:scale-95 transition-all duration-200 disabled:transform-none disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Enhancement Suggestions
                        </span>
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                    </button>
                    <button onclick="analyzeDocuments('formalize')" 
                            class="analysis-btn btn btn-primary group relative overflow-hidden transform hover:scale-105 active:scale-95 transition-all duration-200 disabled:transform-none disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Formalize Tone
                        </span>
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                    </button>
                    <button onclick="analyzeDocuments('grammar')" 
                            class="analysis-btn btn btn-primary group relative overflow-hidden transform hover:scale-105 active:scale-95 transition-all duration-200 disabled:transform-none disabled:cursor-not-allowed">
                        <span class="relative z-10 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Spelling/Grammar Check
                        </span>
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                    </button>
                </div>
                <div id="analysisStatus" class="status-message mt-4 text-center"></div>
            </div>
        </div>
    </div>

    <!-- Document Selection Interface -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Document Selection</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filename</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for document in documents %}
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4">
                            <input type="checkbox" 
                                   class="document-select form-checkbox" 
                                   data-id="{{ document.id }}"
                                   data-type="{{ document.processing_type }}">
                        </td>
                        <td class="px-6 py-4">{{ document.filename }}</td>
                        <td class="px-6 py-4">{{ document.processing_type }}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                {% if document.processing_status == 'completed' %}bg-green-100 text-green-800
                                {% elif document.processing_status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ document.processing_status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {{ document.uploaded_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- General Document Upload Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">Upload Emergency Documents</h2>
        <form id="uploadForm" class="space-y-4">
            <div>
                <label for="document" class="block text-gray-700 font-medium mb-2">Upload Emergency Plans & Resources</label>
                <input type="file" 
                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" 
                       id="document" 
                       accept=".pdf,.docx,.txt,.md,.json">
                <div id="uploadProgress" class="progress-bar mt-2 hidden">
                    <div class="progress-bar-fill" style="width: 0%"></div>
                </div>
                <p id="uploadStatus" class="status-message"></p>
            </div>
            <div>
                <label for="processing_type" class="block text-gray-700 font-medium mb-2">Processing Type</label>
                <select id="processing_type" 
                        name="processing_type" 
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    <option value="text">Text Extraction</option>
                    <option value="summary">Document Summary</option>
                    <option value="analysis">Document Analysis</option>
                    <option value="insurance_requirements">Insurance Requirements</option>
                </select>
            </div>
            <div>
                <label for="format_type" class="block text-gray-700 font-medium mb-2">Format Options</label>
                <select id="format_type" 
                        name="format_type" 
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    <option value="plain">Plain Text</option>
                    <option value="markdown">Markdown</option>
                    <option value="json">JSON</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" 
                       id="cleanup" 
                       name="cleanup" 
                       class="form-checkbox">
                <label for="cleanup" class="ml-2 block text-gray-700">
                    Clean Up (Spellcheck and Grammar)
                </label>
            </div>
            <button type="submit" 
                    class="btn btn-primary w-full sm:w-auto transform hover:scale-105 active:scale-95 transition-all duration-200">
                <span class="relative inline-flex items-center">
                    Upload Document
                    <span class="absolute right-0 -mr-1 h-4 w-4 animate-ping rounded-full bg-white opacity-75 hidden"></span>
                </span>
            </button>
        </form>
    </div>
</div>

<script>
// Loading state management
function showLoading(message = 'Processing...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    loadingText.textContent = message;
    overlay.classList.add('active');
    disableButtons();
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.remove('active');
    enableButtons();
}

function disableButtons() {
    document.querySelectorAll('.btn').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.querySelector('.animate-ping')?.classList.remove('hidden');
    });
}

function enableButtons() {
    document.querySelectorAll('.btn').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.querySelector('.animate-ping')?.classList.add('hidden');
    });
}

function updateProgress(progressBar, progress) {
    if (progressBar) {
        progressBar.classList.remove('hidden');
        progressBar.querySelector('.progress-bar-fill').style.width = `${progress}%`;
    }
}

function updateStatus(statusElement, message, type = 'processing') {
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `status-message status-${type} ${type === 'error' ? 'animate-shake' : ''}`;
    }
}

function showError(message, isConflict = false) {
    if (isConflict) {
        if (confirm(message + '\nWould you like to rename the file and try again?')) {
            const fileInput = document.getElementById('document');
            const file = fileInput.files[0];
            const newName = prompt('Enter a new filename:', file.name);
            if (newName) {
                const renamedFile = new File([file], newName, { type: file.type });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(renamedFile);
                fileInput.files = dataTransfer.files;
                return true;
            }
        }
        return false;
    } else {
        const statusElement = document.getElementById('analysisStatus');
        updateStatus(statusElement, message, 'error');
        return false;
    }
}

function validateDocumentSelection() {
    const selectedDocs = document.querySelectorAll('.document-select:checked');
    if (selectedDocs.length !== 2) {
        showError('Please select exactly two documents for analysis: one requirements document and one claim document');
        return false;
    }

    const hasRequirements = Array.from(selectedDocs).some(
        checkbox => checkbox.dataset.type === 'insurance_requirements'
    );
    if (!hasRequirements) {
        showError('One document must be an insurance requirements document');
        return false;
    }

    const otherDoc = Array.from(selectedDocs).find(
        checkbox => checkbox.dataset.type !== 'insurance_requirements'
    );
    if (!otherDoc) {
        showError('Please select a claim document to analyze');
        return false;
    }

    return true;
}

async function analyzeDocuments(analysisType) {
    // Reset status messages
    updateStatus(document.getElementById('analysisStatus'), '', 'processing');
    
    // Validate document selection
    if (!validateDocumentSelection()) return;

    // Show loading state with specific message
    showLoading('Starting document analysis...');
    const analysisStatusElement = document.getElementById('analysisStatus');
    
    try {
        // Update status with more specific message
        updateStatus(analysisStatusElement, 'Preparing documents for analysis...', 'processing');
        
        const selectedDocs = document.querySelectorAll('.document-select:checked');
        const requirementsDoc = Array.from(selectedDocs).find(
            checkbox => checkbox.dataset.type === 'insurance_requirements'
        );
        const claimDoc = Array.from(selectedDocs).find(
            checkbox => checkbox.dataset.type !== 'insurance_requirements'
        );

        // Update status with progress
        updateStatus(analysisStatusElement, `Analyzing documents using ${analysisType} method...`, 'processing');

        const response = await fetch('/insurance-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                requirement_document_id: requirementsDoc.dataset.id,
                claim_document_id: claimDoc.dataset.id,
                analysis_type: analysisType
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || data.details || 'Analysis failed');
        }

        // Show success message and prepare for redirect
        updateStatus(
            analysisStatusElement,
            'Analysis completed successfully! Redirecting to chat interface...',
            'success'
        );
        
        // Delay redirect slightly to show success message
        setTimeout(() => {
            window.location.href = `/chat?chat_id=${data.chat_id}`;
        }, 1500);

    } catch (error) {
        console.error('Analysis error:', error);
        updateStatus(
            analysisStatusElement,
            `Error: ${error.message || 'Failed to complete analysis'}`,
            'error'
        );
    } finally {
        // Only hide loading if there was an error
        // Keep it visible if success (will be hidden by redirect)
        if (analysisStatusElement.classList.contains('status-error')) {
            setTimeout(() => hideLoading(), 1000);
        }
    }
}

// Document upload form handlers
document.getElementById('requirementsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('requirementsDoc');
    const progressBar = document.getElementById('requirementsProgress');
    const statusElement = document.getElementById('requirementsStatus');
    
    if (!fileInput.files[0]) {
        updateStatus(statusElement, 'Please select a file', 'error');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('processing_type', 'insurance_requirements');
    
    showLoading('Uploading requirements document...');
    updateProgress(progressBar, 0);
    updateStatus(statusElement, 'Uploading...', 'processing');
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (response.ok) {
            updateProgress(progressBar, 100);
            updateStatus(statusElement, 'Requirements document uploaded successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else if (response.status === 409) {
            if (showError(data.error, true)) {
                e.target.dispatchEvent(new Event('submit'));
            }
        } else {
            updateStatus(statusElement, data.error || 'Upload failed', 'error');
        }
    } catch (error) {
        updateStatus(statusElement, 'Error uploading document', 'error');
    } finally {
        hideLoading();
    }
});

// Similar handlers for claimForm and uploadForm...
document.getElementById('claimForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('claimDoc');
    const progressBar = document.getElementById('claimProgress');
    const statusElement = document.getElementById('claimStatus');
    
    if (!fileInput.files[0]) {
        updateStatus(statusElement, 'Please select a file', 'error');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('processing_type', 'text');
    
    showLoading('Uploading claim document...');
    updateProgress(progressBar, 0);
    updateStatus(statusElement, 'Uploading...', 'processing');
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (response.ok) {
            updateProgress(progressBar, 100);
            updateStatus(statusElement, 'Claim document uploaded successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else if (response.status === 409) {
            if (showError(data.error, true)) {
                e.target.dispatchEvent(new Event('submit'));
            }
        } else {
            updateStatus(statusElement, data.error || 'Upload failed', 'error');
        }
    } catch (error) {
        updateStatus(statusElement, 'Error uploading document', 'error');
    } finally {
        hideLoading();
    }
});

// Handle general document upload
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('document');
    const processingType = document.getElementById('processing_type');
    const formatType = document.getElementById('format_type');
    const cleanup = document.getElementById('cleanup');
    const progressBar = document.getElementById('uploadProgress');
    const statusElement = document.getElementById('uploadStatus');
    
    if (!fileInput.files[0]) {
        updateStatus(statusElement, 'Please select a file', 'error');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('processing_type', processingType.value);
    formData.append('format_type', formatType.value);
    formData.append('cleanup', cleanup.checked);
    
    showLoading('Uploading document...');
    updateProgress(progressBar, 0);
    updateStatus(statusElement, 'Uploading...', 'processing');
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (response.ok) {
            updateProgress(progressBar, 100);
            updateStatus(statusElement, 'Document uploaded successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else if (response.status === 409) {
            if (showError(data.error, true)) {
                e.target.dispatchEvent(new Event('submit'));
            }
        } else {
            updateStatus(statusElement, data.error || 'Upload failed', 'error');
        }
    } catch (error) {
        updateStatus(statusElement, 'Error uploading document', 'error');
    } finally {
        hideLoading();
    }
});
</script>

<style>
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.animate-shake {
    animation: shake 0.5s ease-in-out;
}
</style>

{% endblock %}