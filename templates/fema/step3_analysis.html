{% extends "fema/base_fema.html" %}

{% set progress = 100 %}

{% block fema_content %}
<div class="bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-2xl font-semibold mb-4">Step 3: Form Analysis</h2>

    <div class="mb-8">
        <div class="flex space-x-4 mb-6">
            <button class="analysis-tab bg-blue-500 text-white px-4 py-2 rounded-lg" data-type="explanation">
                Form Explanation
            </button>
            <button class="analysis-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-type="enhancement">
                Suggestions
            </button>
            <button class="analysis-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-type="rejection">
                Potential Issues
            </button>
            <button class="analysis-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg" data-type="language">
                Language Review
            </button>
        </div>

        <div id="analysisContent" class="space-y-6">
            <div id="loadingState" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-gray-600">Analyzing your form...</p>
            </div>

            <div id="analysisResults" class="hidden">
                <!-- Results will be populated here -->
            </div>

            <template id="priorityTemplate">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <span class="priority-indicator w-3 h-3 rounded-full mr-2"></span>
                        <span class="priority-label"></span>
                    </h3>
                    <ul class="space-y-2 priority-items">
                    </ul>
                </div>
            </template>

            <template id="itemTemplate">
                <li class="flex items-start">
                    <span class="text-gray-600 mr-2"></span>
                    <span class="text-gray-800"></span>
                </li>
            </template>
        </div>
    </div>

    <div class="flex justify-between mt-8 pt-6 border-t">
        <a href="{{ url_for('fema.step2_form') }}?form_id={{ request.args.get('form_id') }}" class="text-gray-600 hover:text-gray-800">
            ‚Üê Back to Form Upload
        </a>
        <a href="{{ url_for('fema.wizard') }}" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
            Start New Analysis
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const analysisContent = document.getElementById('analysisContent');
        const loadingState = document.getElementById('loadingState');
        const analysisResults = document.getElementById('analysisResults');
        const priorityTemplate = document.getElementById('priorityTemplate');
        const itemTemplate = document.getElementById('itemTemplate');
        const tabs = document.querySelectorAll('.analysis-tab');
        const formId = new URLSearchParams(window.location.search).get('form_id');

        let currentAnalysis = null;

        // Tab click handlers
        tabs.forEach(tab => {
            tab.addEventListener('click', async function() {
                const analysisType = this.dataset.type;
                
                // Update tab styles
                tabs.forEach(t => {
                    t.classList.remove('bg-blue-500', 'text-white');
                    t.classList.add('bg-gray-200', 'text-gray-700');
                });
                this.classList.remove('bg-gray-200', 'text-gray-700');
                this.classList.add('bg-blue-500', 'text-white');

                // Show loading state
                loadingState.classList.remove('hidden');
                analysisResults.classList.add('hidden');

                try {
                    const response = await fetch('/fema/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            form_id: formId,
                            analysis_type: analysisType
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        displayAnalysis(data.analysis, analysisType);
                    } else {
                        throw new Error(data.error || 'Analysis failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred during analysis.');
                } finally {
                    loadingState.classList.add('hidden');
                    analysisResults.classList.remove('hidden');
                }
            });
        });

        function displayAnalysis(analysis, type) {
            analysisResults.innerHTML = '';
            
            const priorities = {
                high: { label: 'High Priority', color: 'bg-red-500' },
                medium: { label: 'Medium Priority', color: 'bg-yellow-500' },
                low: { label: 'Low Priority', color: 'bg-green-500' }
            };

            Object.entries(priorities).forEach(([priority, config]) => {
                if (analysis[priority] && analysis[priority].length > 0) {
                    const section = priorityTemplate.content.cloneNode(true);
                    
                    section.querySelector('.priority-label').textContent = config.label;
                    section.querySelector('.priority-indicator').classList.add(config.color);
                    
                    const itemsList = section.querySelector('.priority-items');
                    analysis[priority].forEach((text, index) => {
                        const item = itemTemplate.content.cloneNode(true);
                        item.querySelector('span:first-child').textContent = `${index + 1}.`;
                        item.querySelector('span:last-child').textContent = text;
                        itemsList.appendChild(item);
                    });

                    analysisResults.appendChild(section);
                }
            });
        }

        // Trigger initial analysis
        tabs[0].click();
    });
</script>
{% endblock %} 