{% extends "insurance/base_insurance.html" %}

{% block insurance_content %}
<div class="space-y-6">
    <h3 class="text-xl font-semibold">Step 1: Upload Insurance Requirements and Policy</h3>
    
    <p class="text-gray-600">Please upload your insurance requirements document or select a previously uploaded document.</p>
    
    {% if previous_documents %}
    <div>
        <h4 class="font-medium mb-2">Previously Uploaded Documents</h4>
        <div class="flex flex-col space-y-2">
            <select id="existingDocumentSelect" class="w-full p-2 border rounded">
                <option value="">Select a document</option>
                {% for doc in previous_documents %}
                    <option value="{{ doc.id }}" {% if doc.id == current_doc_id %}selected{% endif %}>
                        {{ doc.filename }} ({{ doc.uploaded_at.strftime('%m/%d/%Y') }})
                    </option>
                {% endfor %}
            </select>
            <button id="reuseDocumentBtn" 
                    type="button"
                    class="bg-indigo-400 text-white px-4 py-2 rounded hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Use Selected Document
            </button>
        </div>
    </div>
    {% endif %}

    <div class="mt-8">
        <h4 class="font-medium mb-2">Upload New Document</h4>
        <div class="border rounded p-4">
            <form id="requirementsForm" action="{{ url_for('chat.upload_requirements') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <input type="file" name="file" id="file" accept=".pdf,.docx,.txt,.md,.json"
                           class="mb-4">
                    <button type="submit" 
                            id="uploadButton"
                            class="bg-indigo-400 text-white px-4 py-2 rounded hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden transition-opacity duration-300 ease-in-out z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p id="loadingText" class="mt-4 text-lg font-semibold text-gray-700">Processing document...</p>
            </div>
        </div>
    </div>

    <div id="requirementsStatus" class="status-message"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const existingDocSelect = document.getElementById('existingDocumentSelect');
    const reuseDocBtn = document.getElementById('reuseDocumentBtn');
    const requirementsForm = document.getElementById('requirementsForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const statusElement = document.getElementById('requirementsStatus');
    const uploadButton = document.getElementById('uploadButton');
    
    function showLoading(message = 'Processing document...') {
        loadingOverlay.classList.remove('hidden');
        document.getElementById('loadingText').textContent = message;
        uploadButton.disabled = true;
        if (reuseDocBtn) reuseDocBtn.disabled = true;
    }
    
    function hideLoading() {
        loadingOverlay.classList.add('hidden');
        uploadButton.disabled = false;
        if (reuseDocBtn) reuseDocBtn.disabled = !existingDocSelect.value;
    }
    
    function showError(message) {
        statusElement.textContent = message;
        statusElement.className = 'status-message text-red-500 mt-4';
    }
    
    if (existingDocSelect && reuseDocBtn) {
        // Initial state
        reuseDocBtn.disabled = !existingDocSelect.value;
        
        // Update button state when selection changes
        existingDocSelect.addEventListener('change', function() {
            reuseDocBtn.disabled = !this.value;
        });

        // Add click event handler for the button
        reuseDocBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            if (!existingDocSelect.value) return;

            try {
                showLoading('Reusing selected document...');
                const formData = new FormData();
                formData.append('reuse_document_id', existingDocSelect.value);
                formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

                const response = await fetch('{{ url_for("chat.upload_requirements") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reuse document');
                }

                window.location.href = '{{ url_for("chat.insurance_wizard", step=2) }}';
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                hideLoading();
            }
        });
    }

    // Handle form submission for new file upload
    requirementsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const fileInput = document.getElementById('file');

        if (!fileInput.files[0]) {
            showError('Please select a file');
            return;
        }

        try {
            showLoading();
            statusElement.textContent = 'Uploading...';
            statusElement.className = 'status-message text-blue-500 mt-4';

            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Upload failed');
            }

            window.location.href = '{{ url_for("chat.insurance_wizard", step=2) }}';
        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
        } finally {
            hideLoading();
        }
    });
});
</script>
{% endblock %}
