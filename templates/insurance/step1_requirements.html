{% extends "insurance/base_insurance.html" %}

{% block insurance_content %}
<div class="space-y-6">
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <h3 class="text-xl font-semibold">Step 1: Upload Insurance Requirements and Policy</h3>
    
    <p class="text-gray-600">Please upload your insurance requirements document or select a previously uploaded document.</p>
    
    {% if previous_documents %}
    <div>
        <h4 class="font-medium mb-2">Previously Uploaded Documents</h4>
        <div class="flex flex-col space-y-2">
            <select id="existingDocumentSelect" class="w-full p-2 border rounded">
                <option value="">Select a document</option>
                {% for doc in previous_documents %}
                    <option value="{{ doc.id }}" {% if doc.id == current_doc_id %}selected{% endif %}>
                        {{ doc.filename }} ({{ doc.uploaded_at.strftime('%m/%d/%Y') }})
                    </option>
                {% endfor %}
            </select>
            <button id="reuseDocumentBtn" 
                    type="button"
                    class="bg-indigo-400 text-white px-4 py-2 rounded hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Use Selected Document
            </button>
        </div>
    </div>
    {% endif %}

    <div class="mt-8">
        <h4 class="font-medium mb-2">Upload New Document</h4>
        <div class="border rounded p-4">
            <form id="requirementsUploadForm" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div>
                    <input type="file" name="file" id="file" accept=".pdf,.docx,.txt,.md,.json"
                           class="mb-4">
                    <button type="submit" 
                            class="bg-indigo-400 text-white px-4 py-2 rounded hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden transition-opacity duration-300 ease-in-out z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p id="loadingText" class="mt-4 text-lg font-semibold text-gray-700">Processing document...</p>
            </div>
        </div>
    </div>

    <div id="requirementsStatus" class="status-message"></div>
</div>

<script src="{{ url_for('static', filename='js/insurance-workflow.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const existingDocSelect = document.getElementById('existingDocumentSelect');
    const reuseDocBtn = document.getElementById('reuseDocumentBtn');
    
    if (existingDocSelect && reuseDocBtn) {
        // Initial state
        reuseDocBtn.disabled = !existingDocSelect.value;
        
        // Update button state when selection changes
        existingDocSelect.addEventListener('change', function() {
            reuseDocBtn.disabled = !this.value;
        });

        // Add click event handler for the button
        reuseDocBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (existingDocSelect.value) {
                DocumentManager.reuseDocument(existingDocSelect.value);
            }
        });
    }
});
</script>
{% endblock %}
